/*
			AVR-Os Version 0.2
		
		The^day^of^DooM

	Create date:   03.04.2006
	Last Update:   28.04.2006

				Карта на паметта:
   ------------------------------------------------------------------------
        Резервираната част на OS (процес номер 0) [2 байта]:	
                $61 - Брой на процесите
                $62 - Номера на процеса изпълняван в момента
                $63 - TASK_MESSAGE
  ------------------------------------------------------------------------
        Масив на процесите - съставен от отделни структури по [5 байта]:

        Масив на процесите - съставен от отделни структури по [5 байта]:

                (((Номер на процеса)*5)+$5F)+0 - SREG на процеса

                (((Номер на процеса)*5)+$5F)+1 - H \    Текуща позиция
                (((Номер на процеса)*5)+$5F)+2 - L /    в процеса

                (((Номер на процеса)*5)+$5F)+3 - H \    Времето на процеса
                (((Номер на процеса)*5)+$5F)+4 - L /    (в машини цикли)
   ------------------------------------------------------------------------

                                     *ВАЖНО*

      1)  При премахване на даден процес то слдващите след него (ако има)
	 си смъкват номера с един надоло.
*/

//------------------------------------------------------------------------------------
.macro OSInit
.cseg
.org $000
	jmp OSReset

.org OC0addr
	rjmp OSTaskManagerF

OSReset:
	ldi r16, low(ramend)
	out spl, r16
	ldi r16, high(ramend)
	out sph, r16

	clr r16
	sts CURRENT_TASK, r16
	sts TASK_COUNTER, r16
	sts TASK_MESSAGE, r16
	clr r16
.endmacro
//------------------------------------------------------------------------------------
/*
	@0 - Името на процеса (label)
	@1 - Брой на машини цикли с който разполага процеса
*/
.macro OSCreateTask
	push XL
	push XH
	push YL
	push YH

	ldi XH, high(@0)
	ldi XL, low(@0)

	ldi YH, high(@1)
	ldi YL, low(@1)
	call OSCreateTaskF

	pop YH
	pop YL
	pop XH
	pop XL
.endmacro
//------------------------------------------------------------------------------------
.macro OSRun
	jmp OSTaskManagerPointOfFirstRun
.endmacro
//------------------------------------------------------------------------------------
/*
	@0 - Номер на процеса за премахване
*/
.macro OSCurrentRemoveTask
	call OSRemoveTaskF
.endmacro
//------------------------------------------------------------------------------------
.macro OSSaveCurrentTask
	pop XH // Изважда позицията на
	pop XL // текущия процес от стека
	/*                 !!!ВНИМАНИЕ!!!     
	   ще работи коректно само ако е извикан при получаване
	   на прекъсване от системния таймер !!! 
	*/

	push r16
	lds r16, CURRENT_TASK
	call OSSaveTaskF
	pop r16
.endmacro
//------------------------------------------------------------------------------------
.macro OSLoadCurrentTask
	push r16
	lds r16, CURRENT_TASK
	call OSLoadTaskF
	pop r16
.endmacro
//------------------------------------------------------------------------------------
.macro OSRemoveTaskBuNumber
	push r16
	ldi r16, @0
	call OSRemoveTaskF
	pop r16
.endmacro
//------------------------------------------------------------------------------------
.macro OSExitFromTask
	cli
	jmp OSExitFromTaskF
.endmacro
//------------------------------------------------------------------------------------
